name: Déploiement sur Azure Functions

# --- Déclencheurs du Workflow ---

# --- Variables d'environnement globales ---
env:
  AZURE_FUNCTIONAPP_NAME: content-recommendation-function # Remplacez par le nom de votre Function App
  PYTHON_VERSION: '3.10'
  AZURE_RESOURCE_GROUP: rg-recommandation-contenu # Nom du groupe de ressources
  AZURE_LOCATION: 'West Europe' # Emplacement des ressources

on:
  push:
    branches:
      - main
  workflow_dispatch:

# --- Définition des Tâches (Jobs) ---
jobs:
  build-and-deploy-function:
    runs-on: ubuntu-latest
    # environment: production # Optionnel. À décommenter si vous configurez un environnement dans les paramètres du dépôt.
    steps:
      # Étape 1: Récupère le code de votre dépôt
      - name: Checkout du code
        uses: actions/checkout@v4

      # Étape 2: Configuration de Python et installation des dépendances pour le linting
      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Installation des dépendances et de l'outil de linting
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      # Étape 2: Connexion à Azure avec vos identifiants
      - name: Connexion à Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Étape 3: Déploiement sur Azure Functions
      # Ajout d'une étape de linting avant le déploiement
      - name: Linter le code avec flake8
        run: |
          # --count affiche le nombre total d'erreurs
          # --show-source affiche la ligne de code en erreur
          flake8 . --count --show-source --statistics

      # Cette action va créer le groupe de ressources, le compte de stockage et la Function App si ils n'existent pas,
      # puis déployer le code. Elle gère également le build distant (Oryx).
      - name: Déploiement sur Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          location: ${{ env.AZURE_LOCATION }}
          package: .
          app-settings: '{"AZURE_CONNECTION_STRING":"${{ secrets.AZURE_CONNECTION_STRING }}", "FUNCTIONS_WORKER_RUNTIME":"python", "WEBSITE_RUN_FROM_PACKAGE":"1"}'
