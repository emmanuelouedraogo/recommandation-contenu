name: Déploiement sur Azure Functions

# --- Déclencheurs du Workflow ---

# --- Variables d'environnement pour le workflow ---
env:
  AZURE_FUNCTIONAPP_NAME: content-recommendation-function # Remplacez par le nom de votre Function App
  PYTHON_VERSION: '3.10'

on:
  push:
    branches:
      - main
  workflow_dispatch:

# --- Définition des Tâches (Jobs) ---
jobs:
  build-and-deploy-function:
    runs-on: ubuntu-latest
    steps:
      # Étape 1: Récupère le code de votre dépôt
      - name: Checkout du code
        uses: actions/checkout@v4

      # Étape 2: Connexion à Azure
      - name: Connexion à Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Étape 3: Configuration de Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # Étape 4: Installation des dépendances
      - name: Installation des dépendances
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Étape 5: Déploiement sur Azure Functions
      - name: Déploiement sur Azure Functions
        # Cette action va zipper le code et les dépendances installées localement
        uses: azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: .

      # Étape 6: Configuration des paramètres de l'application
      - name: Configuration des paramètres de l'application
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az functionapp config appsettings set --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group rg-recommandation-contenu --settings "AZURE_CONNECTION_STRING=${{ secrets.AZURE_CONNECTION_STRING }}" "FUNCTIONS_WORKER_RUNTIME=python" "SCM_DO_BUILD_DURING_DEPLOYMENT=false" "ENABLE_ORYX_BUILD=false"
            az functionapp config set --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group rg-recommandation-contenu --linux-fx-version "PYTHON|${{ env.PYTHON_VERSION }}"