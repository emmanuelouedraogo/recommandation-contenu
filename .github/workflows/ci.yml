name: Build et Déploiement de l'App Web Flask sur Azure

# --- Déclencheurs du Workflow ---
env:
  AZURE_WEBAPP_NAME: reco-contenu-app # << METTEZ ICI LE NOM DE VOTRE AZURE APP SERVICE
  PYTHON_VERSION: '3.11'
  AZURE_RESOURCE_GROUP: rg-recommandation-contenu # Nom du groupe de ressources
  AZURE_LOCATION: 'francecentral' # Emplacement des ressources

on:
  push:
    branches:
      - main
  workflow_dispatch:

# --- Définition des Tâches (Jobs) ---
jobs:
  test:
    name: Exécuter les tests unitaires
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip' # Activer le cache pour accélérer les installations

      - name: Installation des dépendances
        run: |
          python -m pip install --upgrade pip
          # Installer les dépendances de dev (contenant pytest) et de production
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install -r requirements.txt

      - name: Exécution des tests avec pytest
        run: python -m pytest tests/

  build-and-deploy:
    name: Build and Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: test # Le déploiement ne se lancera que si la tâche 'test' réussit
    environment: production
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Connexion à Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Création du paquet de déploiement
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          zip -r release.zip . -x ".git/*" ".github/*" "venv/*" "__pycache__/*"

      - name: Déploiement sur Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: release.zip
          # La commande de démarrage pour une application Flask en production
          startup-command: 'gunicorn --bind=0.0.0.0 --workers=4 app:app'
