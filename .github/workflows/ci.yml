name: Build et Déploiement de l'App Web Flask sur Azure

# --- Déclencheurs du Workflow ---
env:
  AZURE_WEBAPP_NAME: content-recommendation-function # Nom de votre application web sur Azure
  AZURE_APP_PLAN: plan-reco-contenu # Nom pour le plan App Service
  PYTHON_VERSION: '3.11'
  AZURE_RESOURCE_GROUP: rg-recommandation-contenu # Nom du groupe de ressources
  AZURE_LOCATION: 'francecentral' # Emplacement des ressources

on:
  push:
    branches:
      - main
  workflow_dispatch:

# --- Définition des Tâches (Jobs) ---
jobs:
  lint:
    name: Vérification de la qualité du code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Installation des dépendances de linting
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          # Installer les dépendances du projet pour que flake8 puisse vérifier les imports
          pip install -r requirements.txt

      - name: Exécution du linter Flake8
        run: |
          # Ignore les erreurs de ligne trop longue (E501) et les sauts de ligne avant un opérateur binaire (W503)
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics --exclude=venv

  test:
    name: Exécuter les tests unitaires
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip' # Activer le cache pour accélérer les installations

      - name: Installation des dépendances
        run: |
          python -m pip install --upgrade pip
          # Installer les dépendances de développement et de production.
          # L'installation de requirements-dev.txt est maintenant explicite.
          pip install -r requirements-dev.txt
          pip install -r requirements.txt

  build-and-deploy:
    name: Build and Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: test # Le déploiement ne se lancera que si la tâche 'test' réussit
    environment: production
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Connexion à Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Création des ressources Azure (si nécessaire)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Vérification et création du groupe de ressources..."
            az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location "${{ env.AZURE_LOCATION }}"

            echo "Vérification et création du plan App Service..."
            az appservice plan create --name ${{ env.AZURE_APP_PLAN }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --location "${{ env.AZURE_LOCATION }}" --sku F1 --is-linux

            echo "Vérification et création de l'application Web..."
            az webapp create --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --plan ${{ env.AZURE_APP_PLAN }} --runtime "PYTHON|${{ env.PYTHON_VERSION }}"
            echo "Ressources Azure prêtes."

      - name: Création du paquet de déploiement
        run: zip -r release.zip . -x ".git/*" ".github/*" "venv/*" "__pycache__/*" "tests/*"

      - name: Déploiement sur Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: release.zip
          # La commande de démarrage pour une application Flask en production
          startup-command: 'gunicorn --bind=0.0.0.0 --workers=4 app:app'
