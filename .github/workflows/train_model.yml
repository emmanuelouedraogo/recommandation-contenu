name: Entraînement et Déploiement du Modèle de Recommandation

# --- Déclencheurs du Workflow ---
on:
  # Permet de lancer ce workflow manuellement depuis l'onglet "Actions" de GitHub
  workflow_dispatch:

  # Exécute le workflow automatiquement tous les dimanches à 3h du matin
  schedule:
    - cron: '0 3 * * 0'
 
# --- Variables d'environnement pour le workflow ---
env:
  PYTHON_VERSION: '3.11'
  AZURE_STORAGE_ACCOUNT_NAME: 'recoappstorage123' # Centralisation du nom du compte
  AZURE_CONTAINER_NAME: 'reco-data'
  MODEL_BLOB_NAME: 'models/hybrid_recommender_pipeline.pkl'
  LOCAL_MODEL_PATH: '/tmp/hybrid_recommender_pipeline.pkl'

# --- Définition des Tâches (Jobs) ---
jobs:
  train-and-upload-model:
    runs-on: ubuntu-latest
    steps:
      # Étape 1: Récupère le code de votre dépôt
      - name: Checkout du code
        uses: actions/checkout@v4

      # Étape 2: Configuration de Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Étape 3: Installation des dépendances
      - name: Installation des dépendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Étape 4: Connexion à Azure via l'identité de charge de travail (Workload Identity)
      - name: Connexion à Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Étape 5: Exécution du script d'entraînement
      # Le script utilise maintenant DefaultAzureCredential, qui hérite de l'authentification de l'étape précédente.
      - name: Exécution du script d'entraînement
        run: python reco_model_script.py
        env:
          # Nous passons uniquement les noms des ressources, pas les secrets.
          AZURE_STORAGE_ACCOUNT_NAME: ${{ env.AZURE_STORAGE_ACCOUNT_NAME }}

      # Étape 6: Chargement du nouveau modèle vers Azure Blob Storage
      # Cette étape utilise également l'authentification héritée.
      - name: Chargement du modèle vers Azure
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az storage blob upload --account-name ${{ env.AZURE_STORAGE_ACCOUNT_NAME }} --container-name ${{ env.AZURE_CONTAINER_NAME }} --file ${{ env.LOCAL_MODEL_PATH }} --name ${{ env.MODEL_BLOB_NAME }} --overwrite --auth-mode login

      - name: Nettoyage
        run: echo "Entraînement et déploiement du modèle terminés."