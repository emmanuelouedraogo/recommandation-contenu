name: Entraînement et Déploiement du Modèle de Recommandation

# --- Déclencheurs du Workflow ---
on:
  # Permet de lancer ce workflow manuellement depuis l'onglet "Actions" de GitHub
  workflow_dispatch:

  # Exécute le workflow automatiquement tous les dimanches à 3h du matin
  schedule:
    - cron: '0 3 * * 0'

# --- Variables d'environnement pour le workflow ---
env:
  PYTHON_VERSION: '3.8'
  AZURE_CONTAINER_NAME: 'reco-data'
  MODEL_BLOB_NAME: 'models/hybrid_recommender_pipeline.pkl'
  LOCAL_MODEL_PATH: '/tmp/hybrid_recommender_pipeline.pkl'

# --- Définition des Tâches (Jobs) ---
jobs:
  train-and-upload-model:
    runs-on: ubuntu-latest
    steps:
      # Étape 1: Récupère le code de votre dépôt
      - name: Checkout du code
        uses: actions/checkout@v4

      # Étape 2: Configuration de Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # Étape 3: Installation des dépendances
      - name: Installation des dépendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Étape 4: Exécution du script d'entraînement
      # Le script va utiliser la chaîne de connexion pour lire les données depuis Azure
      # et sauvegarder le modèle entraîné dans /tmp/
      - name: Exécution du script d'entraînement
        run: python reco_model_script.py
        env:
          AZURE_CONNECTION_STRING: ${{ secrets.AZURE_CONNECTION_STRING }}

      # Étape 5: Chargement du nouveau modèle vers Azure Blob Storage
      - name: Connexion à Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Chargement du modèle vers Azure
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az storage blob upload --account-name recoappstorage123 --container-name ${{ env.AZURE_CONTAINER_NAME }} --file ${{ env.LOCAL_MODEL_PATH }} --name ${{ env.MODEL_BLOB_NAME }} --overwrite

      - name: Nettoyage
        run: echo "Entraînement et déploiement du modèle terminés."